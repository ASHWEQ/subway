<!DOCTYPE html>
<html>
<head>
  <script src="http://d3js.org/d3.v4.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
			font-family: sans-serif;
    }
    svg {
      background-color: #f8f8ff;
      height: 100%;
      width: 100%;
    }
		.tooltip {
			position: absolute;
			pointer-events: none;
			background-color: #2a2a2f;
			color: white;
			font-size: small;
			padding: 4px 8px;
		}
		svg {
			cursor: -webkit-grab;
			cursor: -moz-grab;
		}
		.stop, .home {
			cursor: pointer;
		}
		.line, .stop {
	    vector-effect: non-scaling-stroke;
		}
		.hour {
			stroke: rgba(0,0,100,0.1);
			stroke-width: 1px;
			fill: transparent;
			z-index: -1;
		}
  </style>
  <script src="subway.js"></script>
  <script src="gtfs_json.js"></script>
  <script src="https://unpkg.com/js-heap@0.3.1/heap.js"></script>
  <script src="virtual_rider.js"></script>
</head>
<body>
  <script>
    let width = 500;
    let height = 500;
    
    let svg = d3.select("body").append("svg").attr("viewBox", '0 0 ' + width + ' ' + height);
		let container = svg.append('g');

		let zoomed = () => {
			console.log(d3.event.transform)
		  container.attr("transform", d3.event.transform);
		}
		let zoom = d3.zoom()
    .scaleExtent([0.7, 4])
    .on("zoom", zoomed);
		svg.call(zoom);
		
		let maxTravelTime = 70 * 60;
		
		container.append("circle").attr("class", "hour").attr("cx", width/2).attr("cy", height/2).attr('r', 60*60/maxTravelTime * 250);
		
    let {stations, lines} = subway;
				
		let travelTimes = null;
		
		let defaultStop = '127'; // times sq
		
		let computeStationPositions = (originStationId) => {
			let originLat = stations[originStationId || defaultStop].lat;
			let originLon = stations[originStationId || defaultStop].lon;
			if (originStationId) {
				travelTimes = computeTravelTimes(originStationId, Object.keys(stations), gtfs_json, 8 * 60 * 60, 'weekdays');
			} else {
				travelTimes = null;
			}
						
			let positions = {};
			for (let stationId of Object.keys(stations)) {
				let {lat, lon} = stations[stationId];
				
				let deltaY = lat - originLat;
				let deltaX = (lon - originLon) * 0.767;
				let angle = Math.atan2(deltaY, deltaX) + 30 / 180 * Math.PI;
				let origDist = Math.sqrt(Math.pow(deltaX, 2) + Math.pow(deltaY, 2));
				
				let dist = originStationId ? (travelTimes[stationId]) / maxTravelTime : origDist * 5;
				positions[stationId] = {x: Math.cos(angle) * dist, y: Math.sin(angle) * dist};
			}
			
			return positions;
		}
		
		let tooltip = document.createElement('div');
		tooltip.setAttribute('class', 'tooltip');
		tooltip.style.display = 'none';
		document.body.appendChild(tooltip);
		
		let shouldHideTooltip = true;
		let addClickHandlers = (selection) => {
			selection.on('click', (d) => {
				    	showHomeStation(d);
				    }).on('mouseenter', (d) => {
							shouldHideTooltip = false;
				    	tooltip.style.top = (d3.event.pageY + 10) + 'px';
							tooltip.style.left = (d3.event.pageX + 10) + 'px';
							tooltip.style.display = 'block';
							let innerHTML = "<strong>" + stations[d].name + "</strong><br/>";
							if (travelTimes) {
								let minutesAway = (travelTimes[d] / 60 | 0);
								innerHTML += minutesAway + ' minutes away';
							}
							tooltip.innerHTML = innerHTML;
				    }).on('mouseleave', (d) => {
							shouldHideTooltip = true;
							setTimeout(() => {
								if (shouldHideTooltip) tooltip.style.display = 'none';
							}, 100);
				    })
		}
		
		let showHomeStation = (homeStationId) => {
			let stationPositions = computeStationPositions(homeStationId);
    
	    let xValue = (stationId) => stationPositions[stationId].x;
	    let yValue = (stationId) => stationPositions[stationId].y;
	    let allStationIds = Object.keys(stations);
	    let xScale = d3.scaleLinear().range([0, width]).domain([ -1, 1 ]);
	    let yScale = d3.scaleLinear().range([height, 0]).domain([ -1, 1 ]);
	    let xMap = (x) => xScale(xValue(x));
	    let yMap = (y) => yScale(yValue(y));
    
	    let lineFunc = d3.line().x(xMap).y(yMap).curve(d3.curveLinear);
			let lineSelection = container.selectAll('.line').data(Object.values(lines));
	    lineSelection.enter().append('path').attr('class', 'line').attr('stroke', (l) => l.color).attr('stroke-width', 3).merge(lineSelection).transition().attr('d', (l) => lineFunc(l.stations)).attr('fill', 'none');
    
	    // let stationList = Object.values(lines)[0].stations;
	    // svg.selectAll('.stop').data(stationList).enter().append('circle').attr('class', 'stop').attr('r', 3.5).attr('cx', xMap).attr('cy', yMap).style('fill', 'black');
			let stopSelection = container.selectAll('.stop').data(Object.keys(stations));
	    let merged = stopSelection.enter().append('circle').attr('class', 'stop').attr('r', '0.5').attr('stroke', 'black').attr('stroke-width', 5).merge(stopSelection);
			merged.transition().attr('cx', xMap).attr('cy', yMap);
			addClickHandlers(merged);
			
			let homeSelection = container.selectAll('.home').data([1]);
			merged = homeSelection.enter().append('circle').attr('class', 'home').attr('r', '3').attr('fill', 'white').attr('stroke', 'black').attr('stroke-width', 2).merge(homeSelection);
			merged.transition().attr('cx', () => xScale(0)).attr('cy', () => yScale(0));
			addClickHandlers(merged);
		}
		showHomeStation(null); // '127'
  </script>
</body>
</html>
